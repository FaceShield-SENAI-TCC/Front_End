<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Empréstimos - Histórico</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f5f7fa;
        color: #333;
      }

      .container {
        display: flex;
        min-height: 100vh;
      }

      /* Menu Lateral */
      .sidebar {
        width: 250px;
        background: linear-gradient(180deg, #2c3e50, #1a2530);
        color: #ecf0f1;
        padding: 20px 0;
        box-shadow: 3px 0 10px rgba(0, 0, 0, 0.2);
      }

      .logo {
        padding: 0 20px 20px;
        border-bottom: 1px solid #34495e;
        margin-bottom: 20px;
      }

      .logo h2 {
        margin: 0;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .menu-item {
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 10px;
        border-left: 3px solid transparent;
      }

      .menu-item:hover {
        background-color: #34495e;
      }

      .menu-item.active {
        background-color: #3498db;
        border-left: 3px solid #fff;
      }

      /* Conteúdo Principal */
      .main-content {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 1px solid #ddd;
      }

      .page-title {
        margin: 0;
        font-size: 1.8rem;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logout-btn {
        padding: 10px 15px;
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
      }

      .logout-btn:hover {
        background: linear-gradient(135deg, #c0392b, #e74c3c);
        transform: translateY(-2px);
      }

      /* Filtros */
      .filters {
        display: flex;
        gap: 20px;
        margin-bottom: 25px;
        flex-wrap: wrap;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      }

      .filter-group {
        flex: 1;
        min-width: 200px;
      }

      .filter-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .filter-group select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.3s;
      }

      .filter-group select:focus {
        border-color: #3498db;
        outline: none;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      }

      /* Tabela */
      .loans-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      }

      .loans-table th {
        background-color: #3498db;
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
      }

      .loans-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
      }

      .loans-table tr:hover {
        background-color: #f8f9fa;
      }

      .status-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-block;
      }

      .status-active {
        background-color: #e8f5e9;
        color: #2e7d32;
      }

      .status-returned {
        background-color: #e3f2fd;
        color: #1565c0;
      }

      .status-delayed {
        background-color: #ffebee;
        color: #c62828;
      }

      /* Paginação */
      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin-top: 25px;
      }

      .pagination button {
        padding: 8px 15px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .pagination button:hover:not(:disabled) {
        background-color: #2980b9;
        transform: translateY(-2px);
      }

      .pagination button:disabled {
        background-color: #bdc3c7;
        cursor: not-allowed;
        transform: none;
      }

      #page-info {
        font-weight: 600;
        color: #2c3e50;
      }

      /* Mensagens de feedback */
      .feedback-message {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        text-align: center;
        font-weight: 600;
      }

      .feedback-error {
        background-color: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
      }

      .feedback-success {
        background-color: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
      }

      /* Responsividade */
      @media (max-width: 768px) {
        .filters {
          flex-direction: column;
        }

        .filter-group {
          min-width: 100%;
        }

        .loans-table {
          display: block;
          overflow-x: auto;
        }

        .sidebar {
          width: 70px;
        }

        .logo h2 span,
        .menu-item span {
          display: none;
        }

        .logo {
          text-align: center;
          padding: 10px 0;
        }
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Menu Lateral -->
      <div class="sidebar">
        <div class="logo">
          <h2>
            <i class="fas fa-tools"></i> <span>Controle de Empréstimos</span>
          </h2>
        </div>
        <div class="menu-item" onclick="window.location.href='../ListaAluno/ListUsuario.html'">
          <i class="fas fa-user"></i> <span>Usuários</span>
        </div>
        <div class="menu-item active">
          <i class="fas fa-clipboard-list"></i> <span>Empréstimos</span>
        </div>
        <div class="menu-item" onclick="window.location.href='../ListaFerramenta/ListaFerramenta.html'">
          <i class="fas fa-toolbox"></i> <span>Ferramentas</span>
        </div>
        <div class="menu-item" onclick="window.location.href='../Locais/local.html'">
          <i class="fas fa-map-marker-alt"></i> <span>Locais</span>
        </div>
        <div class="menu-item" onclick="window.location.href='../PostEmp/PostEmp.html'">
          <i class="fas fa-plus-circle"></i> <span>Novo Empréstimo</span>
        </div>
        <div class="menu-item" onclick="window.location.href='../index.html'">
          <i class="fas fa-sign-out-alt"></i> <span>Sair</span>
        </div>
      </div>

      <!-- Conteúdo Principal -->
      <div class="main-content">
        <div class="header">
          <h1 class="page-title">
            <i class="fas fa-history"></i> Histórico de Empréstimos
          </h1>
          <button
            class="logout-btn"
            onclick="window.location.href='../index.html'"
          >
            <i class="fas fa-sign-out-alt"></i> Sair do Sistema
          </button>
        </div>

        <!-- Mensagens de feedback -->
        <div
          id="feedback-message"
          class="feedback-message"
          style="display: none"
        ></div>

        <!-- Filtros -->
        <div class="filters">
          <div class="filter-group">
            <label for="filter-user"><i class="fas fa-user"></i> Usuário</label>
            <select id="filter-user">
              <option value="">Todos os usuários</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filter-tool"
              ><i class="fas fa-toolbox"></i> Ferramenta</label
            >
            <select id="filter-tool">
              <option value="">Todas as ferramentas</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filter-status"
              ><i class="fas fa-info-circle"></i> Status</label
            >
            <select id="filter-status">
              <option value="">Todos os status</option>
              <option value="active">Em andamento</option>
              <option value="returned">Devolvido</option>
              <option value="delayed">Em atraso</option>
            </select>
          </div>
        </div>

        <!-- Tabela de Empréstimos -->
        <div style="overflow-x: auto">
          <table class="loans-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Usuário</th>
                <th>Turma</th>
                <th>Ferramenta</th>
                <th>Localização</th>
                <th>Data Retirada</th>
                <th>Data Devolução</th>
                <th>Status</th>
                <th>Observações</th>
              </tr>
            </thead>
            <tbody id="loans-table-body">
              <!-- Dados serão carregados via JavaScript -->
            </tbody>
          </table>
        </div>

        <!-- Paginação -->
        <div class="pagination">
          <button id="prev-page" disabled>
            <i class="fas fa-chevron-left"></i> Anterior
          </button>
          <span id="page-info">Página 1 de 1</span>
          <button id="next-page">
            Próxima <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

    <script>
      // Elementos DOM
      const loansTableBody = document.getElementById("loans-table-body");
      const filterUser = document.getElementById("filter-user");
      const filterTool = document.getElementById("filter-tool");
      const filterStatus = document.getElementById("filter-status");
      const prevPageBtn = document.getElementById("prev-page");
      const nextPageBtn = document.getElementById("next-page");
      const pageInfo = document.getElementById("page-info");
      const feedbackMessage = document.getElementById("feedback-message");

      // URLs da API (com fallback para dados mockados em caso de erro)
      const EMPRESTIMOS_API = "http://localhost:8080/emprestimos/buscar";
      const USUARIOS_API = "http://localhost:8080/usuarios/buscar";
      const FERRAMENTAS_API = "http://localhost:8080/ferramentas/buscar";

      // Variáveis globais
      let currentPage = 1;
      const itemsPerPage = 10;
      let allLoans = [];
      let filteredLoans = [];
      let usuarios = [];
      let ferramentas = [];
      let useMockData = false;

      // Função para exibir mensagem de feedback
      function showFeedback(message, type = "error") {
        feedbackMessage.textContent = message;
        feedbackMessage.className = `feedback-message feedback-${type}`;
        feedbackMessage.style.display = "block";

        if (type === "success") {
          setTimeout(() => {
            feedbackMessage.style.display = "none";
          }, 3000);
        }
      }

      // Função para verificar se o servidor está respondendo
      async function checkServerStatus() {
        try {
          const response = await fetch(EMPRESTIMOS_API, {
            method: 'HEAD',
            cache: 'no-store'
          });
          return response.ok;
        } catch (error) {
          console.error("Servidor offline, usando dados mockados:", error);
          return false;
        }
      }

      // Dados mockados para quando a API não estiver disponível
      function getMockData() {
        return {
          loans: [
            {
              id: 1,
              usuario: { id: 1, nome: "João", sobrenome: "Silva", turma: "3A" },
              ferramenta: { id: 1, nome: "Alicate", local: { nomeEspaco: "Oficina", armario: "A", prateleira: "2" } },
              data_retirada: "2023-10-15T10:30:00",
              data_devolucao: "2023-10-17T14:25:00",
              observacoes: "Devolvido com pequeno desgaste"
            },
            {
              id: 2,
              usuario: { id: 2, nome: "Maria", sobrenome: "Santos", turma: "2B" },
              ferramenta: { id: 2, nome: "Chave de Fenda", local: { nomeEspaco: "Oficina", armario: "B", prateleira: "3" } },
              data_retirada: "2023-10-18T09:15:00",
              data_devolucao: null,
              observacoes: "Em uso"
            }
          ],
          users: [
            { id: 1, nome: "João", sobrenome: "Silva", turma: "3A" },
            { id: 2, nome: "Maria", sobrenome: "Santos", turma: "2B" },
            { id: 3, nome: "Pedro", sobrenome: "Oliveira", turma: "4C" }
          ],
          tools: [
            { id: 1, nome: "Alicate" },
            { id: 2, nome: "Chave de Fenda" },
            { id: 3, nome: "Martelo" }
          ]
        };
      }

      // Função para carregar empréstimos
      async function loadLoans() {
        try {
          showFeedback("Carregando empréstimos...", "success");
          
          let data;
          
          if (useMockData) {
            // Usar dados mockados
            const mockData = getMockData();
            data = mockData.loans;
            showFeedback("Usando dados de demonstração (servidor offline)", "success");
          } else {
            // Tentar carregar da API
            const response = await fetch(EMPRESTIMOS_API);

            if (!response.ok) {
              throw new Error(`Erro HTTP ${response.status}`);
            }

            data = await response.json();
          }

          allLoans = data;
          filteredLoans = [...allLoans];

          renderTable();
          setupPagination();

          setTimeout(() => {
            feedbackMessage.style.display = "none";
          }, 2000);
        } catch (error) {
          console.error("Erro ao carregar empréstimos:", error);
          
          // Tentar usar dados mockados em caso de erro
          if (!useMockData) {
            useMockData = true;
            showFeedback("Servidor offline, usando dados de demonstração", "error");
            loadLoans();
            loadUsers();
            loadTools();
          } else {
            showFeedback("Erro ao carregar empréstimos. Verifique se o servidor está rodando.");
          }
        }
      }

      // Função para carregar usuários (para filtro)
      async function loadUsers() {
        try {
          let data;
          
          if (useMockData) {
            const mockData = getMockData();
            data = mockData.users;
          } else {
            const response = await fetch(USUARIOS_API);

            if (!response.ok) {
              throw new Error(`Erro HTTP ${response.status}`);
            }

            data = await response.json();
          }

          usuarios = data;

          // Limpar e preencher o select
          filterUser.innerHTML = '<option value="">Todos os usuários</option>';
          usuarios.forEach((user) => {
            const option = document.createElement("option");
            option.value = user.id;
            option.textContent = `${user.nome || ''} ${user.sobrenome || ''}`.trim();
            filterUser.appendChild(option);
          });
        } catch (error) {
          console.error("Erro ao carregar usuários:", error);
          // Não mostrar erro para não sobrecarregar a interface
        }
      }

      // Função para carregar ferramentas (para filtro)
      async function loadTools() {
        try {
          let data;
          
          if (useMockData) {
            const mockData = getMockData();
            data = mockData.tools;
          } else {
            const response = await fetch(FERRAMENTAS_API);

            if (!response.ok) {
              throw new Error(`Erro HTTP ${response.status}`);
            }

            data = await response.json();
          }

          ferramentas = data;

          // Limpar e preencher o select
          filterTool.innerHTML = '<option value="">Todas as ferramentas</option>';
          ferramentas.forEach((tool) => {
            const option = document.createElement("option");
            option.value = tool.id;
            option.textContent = tool.nome;
            filterTool.appendChild(option);
          });
        } catch (error) {
          console.error("Erro ao carregar ferramentas:", error);
          // Não mostrar erro para não sobrecarregar a interface
        }
      }

      // Função para renderizar a tabela com tratamento de erros
      function renderTable() {
        loansTableBody.innerHTML = "";

        if (filteredLoans.length === 0) {
          loansTableBody.innerHTML = `
            <tr>
                <td colspan="9" style="text-align: center; padding: 20px;">
                    Nenhum empréstimo encontrado
                </td>
            </tr>
          `;
          return;
        }

        // Calcular itens para a página atual
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, filteredLoans.length);
        const currentLoans = filteredLoans.slice(startIndex, endIndex);

        currentLoans.forEach((loan) => {
          const row = document.createElement("tr");

          // Verificar se os objetos existem para evitar erros
          const usuario = loan.usuario || {};
          const ferramenta = loan.ferramenta || {};
          const local = ferramenta.local || {};

          // Calcular status
          const status = calculateLoanStatus(loan);

          row.innerHTML = `
            <td>${loan.id || "N/A"}</td>
            <td>${(usuario.nome ? `${usuario.nome} ${usuario.sobrenome || ''}` : "N/A")}</td>
            <td>${usuario.turma || "N/A"}</td>
            <td>${ferramenta.nome || "N/A"}</td>
            <td>${local.nomeEspaco ? `${local.nomeEspaco} - Arm. ${local.armario}, Prat. ${local.prateleira}` : "N/A"}</td>
            <td>${formatDate(loan.data_retirada)}</td>
            <td>${loan.data_devolucao ? formatDate(loan.data_devolucao) : "Pendente"}</td>
            <td>
                <span class="status-badge ${getStatusClass(status)}">
                    ${status}
                </span>
            </td>
            <td>${loan.observacoes || "Nenhuma"}</td>
          `;

          loansTableBody.appendChild(row);
        });
      }

      // Função para calcular o status do empréstimo
      function calculateLoanStatus(loan) {
        if (loan.data_devolucao) {
          return "Devolvido";
        }

        const now = new Date();
        const retiradaDate = new Date(loan.data_retirada);
        
        // Considerar atraso se passaram mais de 7 dias
        const diffTime = Math.abs(now - retiradaDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays > 7) {
          return "Em atraso";
        }
        
        return "Em andamento";
      }

      // Função para obter classe CSS do status
      function getStatusClass(status) {
        switch (status) {
          case "Em andamento":
            return "status-active";
          case "Devolvido":
            return "status-returned";
          case "Em atraso":
            return "status-delayed";
          default:
            return "";
        }
      }

      // Função para formatar data
      function formatDate(dateString) {
        if (!dateString) return "N/A";

        try {
          const date = new Date(dateString);
          return date.toLocaleDateString("pt-BR", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
        } catch (error) {
          console.error("Erro ao formatar data:", error, dateString);
          return "Data inválida";
        }
      }

      // Função para configurar paginação
      function setupPagination() {
        const totalPages = Math.ceil(filteredLoans.length / itemsPerPage) || 1;

        // Atualizar informações da página
        pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;

        // Habilitar/desabilitar botões
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;

        // Adicionar event listeners
        prevPageBtn.onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            renderTable();
            setupPagination();
          }
        };

        nextPageBtn.onclick = () => {
          if (currentPage < totalPages) {
            currentPage++;
            renderTable();
            setupPagination();
          }
        };
      }

      // Função para aplicar filtros
      function applyFilters() {
        const userId = filterUser.value;
        const toolId = filterTool.value;
        const status = filterStatus.value;

        filteredLoans = allLoans.filter((loan) => {
          // Filtro por usuário
          if (userId && loan.usuario && loan.usuario.id != userId) return false;

          // Filtro por ferramenta
          if (toolId && loan.ferramenta && loan.ferramenta.id != toolId) return false;

          // Filtro por status
          if (status) {
            const loanStatus = calculateLoanStatus(loan).toLowerCase();
            const statusMap = {
              active: "em andamento",
              returned: "devolvido",
              delayed: "em atraso",
            };

            if (loanStatus !== statusMap[status]) return false;
          }

          return true;
        });

        currentPage = 1;
        renderTable();
        setupPagination();
      }

      // Adicionar event listeners para filtros
      filterUser.addEventListener("change", applyFilters);
      filterTool.addEventListener("change", applyFilters);
      filterStatus.addEventListener("change", applyFilters);

      // Inicializar
      document.addEventListener("DOMContentLoaded", async function () {
        // Verificar status do servidor primeiro
        const serverOnline = await checkServerStatus();
        useMockData = !serverOnline;
        
        loadUsers();
        loadTools();
        loadLoans();
      });
    </script>
  </body>
</html>